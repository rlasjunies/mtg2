{"version":3,"sources":["authentication/localAuth.ts"],"names":["register","login","authenticationCheck"],"mappings":"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","file":"authentication/localAuth.js","sourcesContent":["import express = require(\"express\");\r\nimport jwt = require(\"jwt-simple\"); \r\nimport moment = require(\"moment\");\r\n\r\nimport $Token = require(\"./token\");\r\nimport $EmailVerification = require(\"./emailVerification\");\r\nimport $log = require(\"../services/logger\");\r\nimport $configSecret = require(\"../services/configSecret\");\r\n\r\nimport $ = require(\"../services/mtg\");\r\nimport $usersModel = require(\"../shared/user\");\r\n\r\nvar moduleName = \"localAuth\";\r\n\r\nexport function register(expReq: express.Request, expRes: express.Response, info:any) {\r\n    $EmailVerification.send(expReq.body.email, expRes);\r\n    $Token.createSendToken(expReq.user, expRes);\r\n}\r\n\r\nexport function login (expReq: express.Request, expRes: express.Response, info:any) {\r\n    $Token.createSendToken(expReq.user, expRes);\r\n}\r\n\r\nexport function authenticationCheck(expReq: express.Request, expRes: express.Response, next:Function) {\r\n    if (!expReq.headers[\"authorization\"]) {\r\n        return expRes.status(401).send({ message: \"you are not authorized!\" });\r\n    } else {\r\n        $log.debug(moduleName + \"@authentication: req.headers['authorization']\" + expReq.headers[\"authorization\"]);\r\n        var authorization = expReq.headers[\"authorization\"];\r\n        var token = authorization.split(\" \")[1];\r\n        try {\r\n            var payload = jwt.decode(token, $configSecret.JWT_SECRET);\r\n        }catch(e){\r\n            payload = {};\r\n        }\r\n\r\n        if (!payload.sub) {\r\n            return expRes.status(401).send({ message: \"Authentication failed\" });\r\n        } else {\r\n            if (moment.unix(payload.exp).diff(moment(), 'second') < 0){\r\n                console.log(\"!!!!token expired!!!\");\r\n            }\r\n\r\n            //load user info\r\n            var users: $usersModel.IUserModel = $usersModel.userModel();\r\n            var qry = { _id: payload.sub};\r\n\r\n            users.find(qry,(err:any, user: $usersModel.IUserDocument[]) => {\r\n                if (err) {\r\n                    return expRes.status(500).write({ message: \"Error trying to find the user.\" + JSON.stringify(err) });\r\n                }\r\n\r\n                $.log.debug(\"expReq.params.id:\" + expReq.params.id);\r\n                $.log.profile(moduleName + \"@find\");\r\n                //expRes.status(200).send(user);\r\n                expReq.user = user[0]._doc;\r\n\r\n                next();\r\n            });\r\n        }\r\n    }\r\n}"],"sourceRoot":"/source/"}