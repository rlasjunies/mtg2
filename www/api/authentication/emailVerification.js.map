{"version":3,"sources":["authentication/emailVerification.ts"],"names":["send","verify","handleError","getHtml"],"mappings":"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","file":"authentication/emailVerification.js","sourcesContent":["///< reference path=\"../typings/tsd.d.ts\"/>\r\nimport * as e from \"express\";\r\nimport * as _ from \"underscore\";\r\nimport * as jwt from \"jwt-simple\";\r\nimport * as fs from  \"fs\";\r\nimport * as nodemailer from \"nodemailer\";\r\nimport * as nodemailer_smtp_transport from \"nodemailer-smtp-transport\";\r\n\r\nimport * as $ConfigSecret from \"../services/configSecret\";\r\nimport * as $Config from \"../services/config\";\r\nimport * as xUser from \"../shared/user\";\r\nimport * as $ from \"../services/mtg\";\r\n\r\n// import smtpTransport = require(\"nodemailer-smtp-transport\");\r\n\r\ninterface IModel {\r\n    verifyUrl: string;\r\n    title: string;\r\n    subTitle: string;\r\n    body: string;\r\n}\r\n\r\ninterface IPayload {\r\n    sub:string\r\n}\r\n\r\nexport function send(email:string, res:e.Response) {\r\n    var payload : IPayload = {\r\n        sub: email\r\n    };\r\n\r\n    var token = jwt.encode(payload, $ConfigSecret.EMAIL_SECRET);\r\n\r\n    //var nSMTPTransportOptions: NodemailerSMTPTransportOptions = {\r\n\r\n    let nSMTPTransportOptions: nodemailer_smtp_transport.SmtpOptions = {\r\n        service: \"Gmail\",\r\n        auth: {\r\n            user: \"rlasjunies@gmail.com\",\r\n            pass: $ConfigSecret.SMTP_PASS\r\n        }\r\n    };\r\n\r\n    var transporter = nodemailer.createTransport(nSMTPTransportOptions);\r\n\r\n    var mailOptions: nodemailer.SendMailOptions = {\r\n        from: \"Richard Lasjunies<rlasjunies@gmail.com>\",\r\n        to: email,\r\n        subject: \"PS Jwt Account verification\",\r\n        html: getHtml(token)\r\n    };\r\n\r\n    transporter.sendMail(mailOptions, (err:Error) => {\r\n        if (err) {\r\n            $.log.error(`Verification email - Error sending to:${mailOptions.to}`);\r\n            //return res.status(500).send(JSON.stringify(err));\r\n            //When here the res is already given\r\n        }else{\r\n            $.log.info(\"Verification email sent to:\" + mailOptions.to);\r\n        }\r\n    });\r\n}\r\n\r\nexport function verify(req: e.xRequest<e.IRouteParamEmpty>, res:e.Response, next:Function) {\r\n    var token = req.query.token;\r\n\r\n    var payload : IPayload = jwt.decode(token, $ConfigSecret.EMAIL_SECRET);\r\n\r\n    var email = payload.sub;\r\n\r\n    if (!email) {\r\n        return handleError(res);\r\n    }\r\n\r\n    var users = xUser.userModel();\r\n    users.findOne({ email: email }, (err:any, userFound: xUser.IUserDocument) => {\r\n        if (err) {\r\n            return res.status(500);\r\n        }\r\n\r\n        if (!userFound) {\r\n            return handleError(res);\r\n        }\r\n\r\n        if (!userFound.active) {\r\n            userFound.active = true;\r\n        }\r\n\r\n        userFound.save((err:any, userFound: xUser.IUserDocument): any => {\r\n            if (err) {\r\n                return res.status(500);\r\n            }\r\n\r\n            return res.redirect(<string>$Config.appUrl[process.env]);\r\n        });\r\n\r\n    });\r\n\r\n}\r\n\r\nfunction handleError(res:e.Response) {\r\n    return res.status(401).send({\r\n        message:\"Authentication failed, enable to verify the email\"\r\n    });\r\n}\r\n\r\nfunction getHtml(token: string) {\r\n\r\n    var model: IModel = {\r\n        // TODO to make generic\r\n        verifyUrl: \"http://localhost:3000/auth/verifyemail?token=\" + token,\r\n        title: \"psJwt\",\r\n        subTitle: \"Thanks for signing up!\",\r\n        body: \"Please, verify your email address by clicking the button below.\"\r\n    };\r\n\r\n    // TODO replace readFileSync by Async\r\n    var html = fs.readFileSync($.server.emailVerificationFileName, { encoding: \"utf8\" });\r\n\r\n    var template = _.template(html);\r\n\r\n    var sReturn = template(model);\r\n\r\n    return sReturn;\r\n}\r\n\r\n_.templateSettings = {\r\n    interpolate: /\\{\\{(.+?)\\}\\}/g\r\n};\r\n"],"sourceRoot":"/source/"}