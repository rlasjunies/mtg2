{"version":3,"sources":["authentication/facebookAuth.ts"],"names":["facebookAuth"],"mappings":"AAAA,IAAY,EAAE,WAAM,aAAa,CAAC,CAAA;AAClC,IAAY,OAAO,WAAM,SAAS,CAAC,CAAA;AAGnC,IAAY,aAAa,WAAM,0BAA0B,CAAC,CAAA;AAC1D,IAAY,OAAO,WAAM,gBAAgB,CAAC,CAAA;AAC1C,IAAY,QAAQ,WAAM,SAAS,CAAC,CAAA;AAOpC,sBAA8B,MAAuB,EAAE,MAAuB;IAE1EA,IAAIA,cAAcA,GAAGA,+CAA+CA,CAACA;IACrEA,IAAIA,WAAWA,GAAGA,+BAA+BA,CAACA;IAElDA,IAAIA,MAAMA,GAAGA;QACTA,SAASA,EAAEA,MAAMA,CAACA,IAAIA,CAACA,QAAQA;QAC/BA,YAAYA,EAAEA,MAAMA,CAACA,IAAIA,CAACA,WAAWA;QACrCA,aAAaA,EAAEA,aAAaA,CAACA,eAAeA;QAC5CA,IAAIA,EAAEA,MAAMA,CAACA,IAAIA,CAACA,IAAIA;KACzBA,CAACA;IAEFA,OAAOA,CAACA,GAAGA,CAACA;QACRA,GAAGA,EAAEA,cAAcA;QACnBA,EAAEA,EAAEA,MAAMA;KACTA,EAAEA,UAACA,GAAOA,EAAEA,QAAYA,EAAEA,WAAeA;QAC1CA,WAAWA,GAAGA,EAAEA,CAACA,KAAKA,CAACA,WAAWA,CAACA,CAACA;QAEpCA,OAAOA,CAACA,GAAGA,CAACA;YACRA,GAAGA,EAAEA,WAAWA;YAChBA,EAAEA,EAAEA,WAAWA;YACfA,IAAIA,EAAEA,IAAIA;SACbA,EAAEA,UAACA,GAAOA,EAAEA,QAAYA,EAAEA,OAAyBA;YAC5CA,IAAIA,KAAKA,GAAGA,OAAOA,CAACA,SAASA,EAAEA,CAACA;YAEhCA,KAAKA,CAACA,OAAOA,CAACA,EAAEA,UAAUA,EAAEA,OAAOA,CAACA,EAAEA,EAAEA,EAAEA,UAACA,GAAGA,EAAEA,YAAYA;gBACxDA,EAAEA,CAACA,CAACA,YAAYA,CAACA,CAACA,CAACA;oBACfA,MAAMA,CAACA,QAAQA,CAACA,eAAeA,CAACA,YAAYA,EAAEA,MAAMA,CAACA,CAACA;gBAC1DA,CAACA;gBACDA,IAAIA,OAAOA,GAA0BA,IAAIA,KAAKA,CAACA,EAAEA,CAACA,CAACA;gBAEnDA,OAAOA,CAACA,UAAUA,GAAGA,OAAOA,CAACA,EAAEA,CAACA;gBAChCA,OAAOA,CAACA,WAAWA,GAAGA,OAAOA,CAACA,IAAIA,CAACA;gBACnCA,iGAAiGA;gBACjGA,6CAA6CA;gBAC7CA,OAAOA,CAACA,IAAIA,CAAwBA,UAACA,GAAGA,EAAEA,IAAIA;oBAC1CA,EAAEA,CAACA,CAACA,GAAGA,CAACA,CAACA,CAACA;wBACNA,MAAMA,GAAGA,CAACA;oBACdA,CAACA;oBAEDA,QAAQA,CAACA,eAAeA,CAACA,OAAOA,EAAEA,MAAMA,CAACA,CAACA;gBAC9CA,CAACA,CAACA,CAACA;YACPA,CAACA,CAACA,CAACA;QACXA,CAACA,CAACA,CAACA;IACPA,CAACA,CAACA,CAACA;AACPA,CAACA;AA7Ce,oBAAY,eA6C3B,CAAA","file":"authentication/facebookAuth.js","sourcesContent":["import * as qs from \"querystring\";\r\nimport * as request from \"request\";\r\nimport * as express from \"express\";\r\n\r\nimport * as $ConfigSecret from \"../services/configSecret\";\r\nimport * as libUser from \"../shared/user\";\r\nimport * as libToken from \"./token\";\r\n\r\ninterface IFacebookProfile {\r\n    id: string;\r\n    name: string;\r\n}\r\n\r\nexport function facebookAuth (expReq: express.Request, expRes:express.Response) {\r\n\r\n    var accessTokenUrl = \"https://graph.facebook.com/oauth/access_token\";\r\n    var graphApiUrl = \"https://graph.facebook.com/me\";\r\n\r\n    var params = {\r\n        client_id: expReq.body.clientId,\r\n        redirect_uri: expReq.body.redirectUri,\r\n        client_secret: $ConfigSecret.FACEBOOK_SECRET,\r\n        code: expReq.body.code\r\n    };\r\n\r\n    request.get({\r\n        url: accessTokenUrl,\r\n        qs: params\r\n        }, (err:any, response:any, accessToken:any) => {\r\n        accessToken = qs.parse(accessToken);\r\n\r\n        request.get({\r\n            url: graphApiUrl,\r\n            qs: accessToken,\r\n            json: true\r\n        }, (err:any, response:any, profile: IFacebookProfile) => {\r\n                var users = libUser.userModel();\r\n\r\n                users.findOne({ facebookId: profile.id }, (err, existingUser) => {\r\n                    if (existingUser) {\r\n                        return libToken.createSendToken(existingUser, expRes);\r\n                    }\r\n                    var newUser: libUser.IUserDocument = new users({});\r\n\r\n                    newUser.facebookId = profile.id;\r\n                    newUser.displayName = profile.name;\r\n                    // TODO pretty sure it\"s not good to store only these information, what\"s happen if the SAME user\r\n                    // login with goodle or local authentication?\r\n                    newUser.save<libUser.IUserDocument>((err, resp) => {\r\n                        if (err) {\r\n                            throw err;\r\n                        }\r\n\r\n                        libToken.createSendToken(newUser, expRes);\r\n                    });\r\n                });\r\n        });\r\n    });\r\n}\r\n"],"sourceRoot":"/source/"}